# We are waiting on the macos-latest image to play nicely with MPI

name: Is-macos-latest-working-yet

on:
  schedule:
    - cron: '0 23 * * 2'
  workflow_dispatch:
  pull_request:

jobs:
  openmpi-on-macos-latest:
    runs-on: macos-11
    steps:
    - uses: actions/checkout@v2
    - uses: conda-incubator/setup-miniconda@v2.2.0
      with:
        python-version: "3.11"
        mamba-version: "*"
        channels: conda-forge
        miniforge-variant: Mambaforge
        channel-priority: strict
        auto-update-conda: true
        environment-file: .ci_support/environment-openmpi.yml
    - name: Test
      shell: bash -l {0}
      timeout-minutes: 10
      run: |
        pip install versioneer[toml]==0.29
        pip install . --no-deps --no-build-isolation
        cd tests
        python -m unittest discover .
      env:
        OMPI_MCA_plm: 'isolated'
        OMPI_MCA_rmaps_base_oversubscribe: 'yes'
        OMPI_MCA_btl_vader_single_copy_mechanism: 'none'
